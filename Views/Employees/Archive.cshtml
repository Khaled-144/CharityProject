@model IEnumerable<CharityProject.Models.Transaction>

@{
    if (Context.Session.GetString("Permission_position") == "مدير الموارد البشرية والمالية")
    {
        Layout = "_Layout_HR";

    }
    else if (Context.Session.GetString("Permission_position") == "مدير خدمة المستفيدين" || Context.Session.GetString("Permission_position") == "مدير التنمية المالية والاستدامة")
    {
        Layout = "_Layout_Managers";
    }
    else if (Context.Session.GetString("Permission_position") == "موظف")
    {
        Layout = "_Layout_Employees";
    }
    else
    {
        Layout = "_Layout";
    }

    ViewData["PageTitle"] = "الارشيف";
    ViewData["Title"] = "صفحة الارشيف";
    var currentUrl = $"{Context.Request.Scheme}://{Context.Request.Host}{Context.Request.Path}{Context.Request.QueryString}";
    ViewBag.CurrentUrl = currentUrl;
}

<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["PageTitle"]</title>
    <link rel="stylesheet" href="~/css/site.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- Add any additional CSS or JS references here -->
    <style>
        .active-tab {
            border-color: #248277;
            color: #248277;
        }
    </style>
</head>

<body>
    <div class="flex justify-self-auto justify-between mt-10">
        <!-- Search and filter -->
        <div class="mx-4">
            <form id="searchForm">
                <div class="flex justify-evenly">
                    <input name="searchTerm" placeholder="رقم المعاملة أو العنوان" class="form-control mr-2" type="search" aria-label="search" />
                    <select name="sortOrder" id="sortOrder" class="bg-white border border-primaryButtons px-5 text-black text-sm rounded-lg text-center focus:ring-blue-500 focus:border-blue-500 block mr-2">
                        <option selected>فلترة</option>
                        <option value="newest">الاحدث</option>
                        <option value="oldest">الاقدم</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
        <ul class="flex flex-wrap -mb-px text-xl font-medium text-center" id="default-tab" role="tablist">
            <li class="me-2 flex items-center" role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg active-tab" id="internal-tab" data-content-url="@Url.Action("GetArchivedTransactions", "Employees")" type="button" role="tab">
                    داخلية
                </button>
            </li>
            <li class="me-2 flex items-center" role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg" id="holidays-tab" data-content-url="@Url.Action("GetArchivedHolidays", "Employees")" type="button" role="tab">
                    إجازات
                </button>
            </li>
            <li class="me-2 flex items-center" role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg" id="letters-tab" data-content-url="@Url.Action("GetArchivedLetters", "Employees")" type="button" role="tab">
                    خطابات
                </button>
            </li>
            <li class="flex items-center" role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg" id="assets-tab" data-content-url="@Url.Action("GetAllAssets", "Employees")" type="button" role="tab">
                    عهده
                </button>
            </li>
        </ul>
    </div>

    <div id="tab-content-container" class="mt-5">
        <!-- Content will be dynamically loaded here -->
    </div>

    <script src="~/js/site.js"></script>
    <script>
        $(document).ready(function () {
            function loadTabContent(url) {
                $("#tab-content-container").html('<div class="text-center"><div class="spinner text-center"></div><p>جاري تحميل المحتوى...</p></div>');
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function (result) {
                        $("#tab-content-container").html(result);
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                        $("#tab-content-container").html('<p class = " text-center ">فشل تحميل المحتوى. حاول مرة أخرى لاحقاً.</p>');
                    }
                });
            }

            $("#default-tab button").on("click", function () {
                var url = $(this).data("content-url");
                loadTabContent(url);
                $("#default-tab button").removeClass("active-tab");
                $(this).addClass("active-tab");
            });

            // Load initial tab content
            $("#internal-tab").trigger("click");
        });
    </script>

    <script>
        $(document).ready(function () {
            var searchTimer;

            function loadTransactions() {
                $("#loadingIndicator").show();
                $("#tab-content-container").hide();

                var searchTerm = $("#searchForm input[name='searchTerm']").val();
                var sortOrder = $("#sortOrder").val();
                var activeTab = $(".active-tab").attr("id");

                console.log("Searching with term:", searchTerm);
                console.log("Sort order:", sortOrder);
                console.log("Active tab:", activeTab);

                var url;
                switch (activeTab) {
                    case "internal-tab":
                        url = '@Url.Action("SearchTransactions", "Employees")';
                        break;
                    case "holidays-tab":
                        url = '@Url.Action("SearchHolidays", "Employees")';
                        break;
                    case "letters-tab":
                        url = '@Url.Action("SearchLetters", "Employees")';
                        break;
                    case "assets-tab":
                        url = '@Url.Action("SearchAssets", "Employees")';
                        break;
                    default:
                        url = '@Url.Action("SearchTransactions", "Employees")';
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    data: { searchTerm: searchTerm, sortOrder: sortOrder },
                    success: function (result) {
                        console.log("Received data:", result);
                        if (result.trim() === "") {
                            // If the result is empty, load the _NothingNew tab
                            $("#tab-content-container").load('@Url.Action("_NothingNew", "Employees")');
                        } else {
                            $("#tab-content-container").html(result);
                        }
                        $("#loadingIndicator").hide();
                        $("#tab-content-container").show();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error:", error);
                        console.error("Status:", status);
                        console.error("Response:", xhr.responseText);
                        $("#loadingIndicator").hide();
                        $("#tab-content-container").show();
                        $("#tab-content-container").html("<p>Error loading transactions. Please try again.</p>");
                    }
                });
            }

            // Trigger search on input change with a delay
            $("#searchForm input[name='searchTerm']").on('input', function () {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(loadTransactions, 1000); // 1000ms delay
            });

            // Trigger search on sort order change
            $("#sortOrder").on("change", function () {
                loadTransactions();
            });

            // Trigger search on tab change
            $("#default-tab button").on("click", function () {
                loadTransactions();
            });

            // Initial load
            loadTransactions();
        });
    </script>
</body>

</html>
